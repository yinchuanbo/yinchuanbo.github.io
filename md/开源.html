<!DOCTYPE html>
<html lang="en" class="">
  <head>
    <meta charset="UTF-8" />
    <meta
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;"
      name="viewport"
    />
    <title>开源</title>
    <link rel="shortcut icon" href="../code.svg" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=fallback"
      rel="stylesheet"
    />
    <link id="prismTheme" rel="stylesheet" href="../css/prism.css" />
    <link rel="stylesheet" href="../css/edit.css" />
    
    <style>
      /* Animation Styles */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .slide-in {
        animation: slideIn 0.5s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .button {
        transition: background-color 0.3s, transform 0.3s;
      }

      .button:hover {
        background-color: #3700b3;
        transform: scale(1.05);
      }

      /* Tooltip Styles */
      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: black;
        color: #fff;
        text-align: center;
        border-radius: 5px;
        padding: 5px 0;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
    </style>
  </head>

  <body class="fade-in">
    <button
      class="toggle-sidebar"
      id="toggleSidebar"
      aria-label="Toggle Sidebar"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>

    <div class="app-container">
      <!-- Sidebar Navigation -->
      <nav class="sidebar">
        <div class="sidebar-header">
          <button class="toggle-sidebar" id="toggleSidebar">
            <span></span>
          </button>
        </div>
        <div class="sidebar-content">
          <div class="nav-section"><li class=""><a title="安全防护" href="/md/安全防护.html">05 安全防护</a></li><li class=""><a title="维护" href="/md/维护.html">04 维护</a></li><li class="active"><a title="开源" href="/md/开源.html">03 开源</a></li><li class=""><a title="测试" href="/md/测试.html">02 测试</a></li><li class=""><a title="构建" href="/md/构建.html">01 构建</a></li></div>
        </div>
      </nav>

      <!-- Main Content Area -->
      <main class="main-content">
        <header class="content-header">
          <div class="header-left">
            <h1 class="page-title">开源</h1>
            <p class="time">HaoTian · 2025-02-01 09:35:03</p>
          </div>
          <div class="header-right">
            <div class="tag-container">
              <span class="tag">现代 JavaScript 库开发</span>
            </div>
            <button
              id="themeToggle"
              class="theme-toggle"
              aria-label="Toggle theme"
            >
              <svg
                class="sun-icon"
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <svg
                class="moon-icon"
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                ></path>
              </svg>
            </button>
            <button
              class="theme-toggle"
              aria-label="Toggle theme"
              style="width: 36px; height: 36px"
              onclick="window.location.href='/md';"
            >
              <svg
                t="1737442501710"
                class="icon"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="5258"
                width="20"
                height="20"
              >
                <path
                  d="M883.773793 626.047476c-17.308201 0-31.408337 14.029528-31.408337 31.304983l0 207.437469c0 17.204847-14.098089 31.302937-31.406291 31.302937L203.040834 896.092865c-17.340947 0-31.408337-14.098089-31.408337-31.302937L171.632497 657.352459c0-17.275455-14.099113-31.304983-31.408337-31.304983-17.380856 0-31.444153 14.029528-31.444153 31.304983l0 207.437469c0 51.773154 42.261523 93.91188 94.260827 93.91188l617.918331 0c52.031027 0 94.259804-42.139749 94.259804-93.91188L915.21897 657.352459C915.21897 640.077004 901.152603 626.047476 883.773793 626.047476L883.773793 626.047476zM230.262826 614.286618c55.523571 0 104.556311-27.674293 134.394896-69.762877 32.487925 46.451962 86.303598 77.0744 147.343813 77.0744 61.036122 0 114.846678-30.623461 147.306974-77.0744 29.943986 42.018999 78.902024 69.762877 134.426619 69.762877 90.948385 0 164.968216-73.77526 164.968216-164.371628 0-11.062963-2.342348-22.859637-5.130857-35.178197-0.209778-1.134847 0.031722-2.26867-0.277316-3.38612l-0.629333-2.267647c-0.24764-0.924045-0.140193-1.535983-0.352017-2.547009-0.138146-0.505513-0.521886-0.87288-0.695848-1.39579l-85.364203-316.671313c-3.699252-13.645788-16.051581-23.172769-30.293957-23.172769L187.965487 65.296145c-14.238282 0-26.665313 9.526981-30.360472 23.24133L72.309374 405.1566c-0.103354 0.50756-0.48607 0.820692-0.62524 1.309832-0.210801 0.942465-0.107447 1.639337-0.349971 2.511193l-0.62524 2.373047c-0.318248 1.11745 0 2.25025-0.210801 3.38612-2.863211 12.31856-5.201465 24.115234-5.201465 35.178197C65.295634 540.511357 139.315464 614.286618 230.262826 614.286618L230.262826 614.286618z"
                  fill="currentColor"
                  p-id="5259"
                ></path>
              </svg>
            </button>
          </div>
        </header>

        <!-- Article Content -->
        <article
          class="content-body md md "
        >
          <p>目前，代码层面的工作已经完成，接下来就需要将库发布给使用者。</p>
<p>但是要想使我们的库称为一个标准开源库，还需要完成一些额外的工作。</p>
<p>比如，如何将我们的库开源到 Github 上，以便开发者找到我们的库，以及如何将构建后的代码发布到 npm 上，方便开发者下载、使用我们的库。</p>
<h2>选择开发协议</h2>
<p>在开源之前，需要先选择一个开源协议</p>
<p>添加开源协议的主要目的：明确声明自己的权利。</p>
<p>如果没有开源协议，则会有两种可能：</p>
<ol>
<li><p>一种可能是会被认为放弃所有权利，此时可能会被剽窃、抄袭等</p>
</li>
<li><p>另一种可能是会被认为协议不明，一般商业项目都会很小心地选择使用的库，如果缺少协议，则一般不会使用</p>
</li>
</ol>
<p>此外，如果开源库存在缺陷，并因此给库的使用者造成了损失，则可能会有法律纠纷，这对于库的开发者来说是非常不利的。</p>
<p>但是通过协议可以提前规避这些问题，综上，建议一定要添加开源协议。</p>
<p>开源项目常用的开源协议有 5 个：<strong>分别是 GPL、LGPL、MIT、BSD、Apache</strong></p>
<p>前端项目使用最多的开源协议是 <strong>MIT</strong>、<strong>BSD</strong> 和 <strong>Apache</strong></p>
<table>
<thead>
<tr>
<th></th>
<th align="center">MIT</th>
<th align="right">BSD</th>
<th align="right">Apache</th>
</tr>
</thead>
<tbody><tr>
<td>商业用途</td>
<td align="center">√</td>
<td align="right">√</td>
<td align="right">√</td>
</tr>
<tr>
<td>可以修改</td>
<td align="center">√</td>
<td align="right">√</td>
<td align="right">√</td>
</tr>
<tr>
<td>可以分发</td>
<td align="center">√</td>
<td align="right">√</td>
<td align="right">√</td>
</tr>
<tr>
<td>授予专利许可</td>
<td align="center"></td>
<td align="right"></td>
<td align="right">√</td>
</tr>
<tr>
<td>私人使用</td>
<td align="center">√</td>
<td align="right">√</td>
<td align="right">√</td>
</tr>
<tr>
<td>商标使用</td>
<td align="center"></td>
<td align="right"></td>
<td align="right">×</td>
</tr>
<tr>
<td>承担责任</td>
<td align="center">×</td>
<td align="right">×</td>
<td align="right">×</td>
</tr>
</tbody></table>
<p>综上，MIT 和 BSD 协议比较相似，Apache 协议的要求则更多，下面是整理的使用这 3 个开源协议在 Github 上排名靠前的项目，可以看到，在影响力较大的项目中，使用 MIT 和 Apache 协议的项目更多一些。</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>项目</th>
</tr>
</thead>
<tbody><tr>
<td>MIT</td>
<td>jQuery、React、Lodash、Vue.js、Angular、ESLint</td>
</tr>
<tr>
<td>BSD</td>
<td>Yeoman、node-inspector</td>
</tr>
<tr>
<td>Apache</td>
<td>ECharts、Less.js、math.js、TypeScript</td>
</tr>
</tbody></table>
<blockquote>
<p>一般的库建议选择 MIT 协议，如果涉及到专利技术，则可以选择 Apache 协议，</p>
</blockquote>
<p>这里为我们编写的深拷贝库选择 MIT 协议，首先，我用下面的命令在根目录下新建一个 <strong>LICENSE</strong> 文件：</p>
<pre><code class="language-sh">touch LICENSE
</code></pre>
<p>接下来，在 LICENSE 文件中添加如下内容，这个协议可以在网上找到，<strong>需要注意的是：要修改 “当前年份”，并将 “开发者的名字” 替换为自己的名字</strong></p>
<hr>
<p>MIT License</p>
<p>Copyright (c) 当前年份 开发者的名字</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
<hr>
<p>MIT 协议是比较宽松的协议，对使用者唯一的要求就是保留协议即可，但也声明了不承担任何责任，是对库开发者的保护，</p>
<h2>完善文档</h2>
<p>当使用一个库时，我们希望有清晰完整的文档，</p>
<p>文档的格式推荐使用 markdown 语法，</p>
<p><strong>一个标准的前端库文档应该包含如下内容：</strong></p>
<ul>
<li><p>README</p>
</li>
<li><p>待办清单</p>
</li>
<li><p>变更日志</p>
</li>
<li><p>API 文档</p>
</li>
</ul>
<h3>README</h3>
<p>README 是库的使用者最先看到的内容，README 的好坏在一定程度上直接影响库的使用者的选择，README 的书写原则是主题清晰、内容简洁。</p>
<p><strong>一个合格的 README 的应该包括如下内容：</strong></p>
<ul>
<li><p>库的介绍：概括介绍库解决的问题</p>
</li>
<li><p>使用者指南：帮助使用者快速了解如何使用</p>
</li>
<li><p>贡献者指南：方便社区为开源库做贡献</p>
</li>
</ul>
<p>首先在根目录下新建一个 README.md 文件，并在该文件中添加下面的 Markdown 代码：</p>
<img src="../imgs/140/08.png" />

<h3>待办清单</h3>
<p>待办清单用来记录即将发布的内容或未来计划，待办清单的主要目的有两个:</p>
<ol>
<li><p>一是告诉库的使用者当前库未来支持的功能，</p>
</li>
<li><p>二是让库的开发者将其作为备忘，提醒自己将来要交付的功能。</p>
</li>
</ol>
<p>在项目的根目录下添加 TODO.md 文件，其内容格式如下所示: <strong>分别记录已经完成的待办事项和未完成的待办事项</strong>。</p>
<img src="../imgs/140/09.png" />

<h3>变更日志</h3>
<p>变更日志用来记录每次更新详细的变更内容，变更日志的主要目的有两个：</p>
<ol>
<li><p>一个方便库的使用者升级版本时了解升级的内容，从而避免升级可能带来的风险；</p>
</li>
<li><p>另一个是方便库的开发者记录变更备忘；</p>
</li>
</ol>
<p>变更日志一般会记录版本号、变更时间和具体的变更内容，变更内容要尽量做到简洁明了。</p>
<p>在项目的根目录下添加 `CHANGELOG.md`` 文件，该文件中的内容如下，每次发布新版本时都要在这里记录更新信息。</p>
<img src="../imgs/140/10.png" />

<h3>API 文档</h3>
<p>API 文档用来提供更详细的内容，包括每个函数的参数、返回值和使用示例。</p>
<p>根据库的功能多少，创建 API 文档时可以选择以下 3 种方案：</p>
<ol>
<li><p>功能较少，可以直接写在 README.md 中</p>
</li>
<li><p>内容较多，可以单独写一个文件</p>
</li>
<li><p>API 数量众多，可以要考虑专门做个网站来提供详细的文档功能，</p>
</li>
</ol>
<p>这里选择第 2 种方案，在项目的根目录下添加 <code>doc/api.md</code> 文件，该文件中的内容如下：</p>
<img src="../imgs/140/11.png" />

<h2>发布</h2>
<h3>发布到 Github 上</h3>
<h3>发布到 npm 上</h3>
<p>npm 解决了库分发下载的各种问题，npm 是全球最大的包托管平台，提供了开源库托管、检索和下载功能。</p>
<p>将开源库发布到 npm 上后，用户只需要一条命令即可完成库的下载工作。</p>
<p>首先需要注册一个 npm 账号，npm 支持将库发布到<strong>全局空间</strong>和<strong>用户空间</strong>下两种方式，</p>
<p>推荐读者将库发布到自己的账号下，因为全局空间名字冲突的概率很大。</p>
<p>此外，npm 也提供了组织（Organization）功能，本书所有代码均发布在 jslib-book 这个组织下面。</p>
<p>完成账号注册后，如果想要通过命令行将库发布到 npm 上，则首先需要在命令行中登录账号，登录成功后可以通过 whoami 命令查看当前的登录账号，实例如下：</p>
<pre><code class="language-sh">npm login
# 输入账号、密码、邮箱等信息

npm whoami
# yanhaijing # 此处显示登录的用户名
</code></pre>
<p>在将库发布之前，需要做一些准备工作。</p>
<p>并不是所有代码都需要发布到 npm 上的，无用的代码发布到 npm 上不仅会浪费存储空间，也会影响使用者的下载库的速度。</p>
<p>从理论上来说，只需要发布 dist 目录和 LICENSE 文件即可。因为，README.md、CHANGELOG.md 和 package.json 文件是默认发布的。</p>
<p><strong>npm 提供了黑名单和白名单两种方式过滤文件</strong></p>
<p>先来介绍黑名单的方式：</p>
<p>npm 不仅会自动忽略 <code>.gitignore</code> 文件中的文件，还会忽略 node_modules 目录和 package-lock.json 文件，</p>
<p>如果还需要忽略其他文件，则可以在根目录下添加一个 <code>.npmignore</code> 文件，该文件的格式和 <code>.gitignore</code> 文件的格式是一样的，<code>.npmignore</code> 文件中的规则匹配的文件都会被 npm 忽略。</p>
<pre><code class="language-sh"># .npmignore
config
doc
src
test
</code></pre>
<p>对于黑名单的方式，在新增不需要发布的文件时，容易因为忘记修改 <code>.npmignore</code> 文件而导致误上传一些无用文件，因此推荐使用白名单的方式，</p>
<p>如果在 package.json 文件中添加 files 字段，则只有在 files 中的文件才会被发布，</p>
<pre><code class="language-json">{
  &quot;files&quot;: [&quot;/dist&quot;, &quot;LICENSE&quot;]
}
</code></pre>
<blockquote>
<p>如果两种方式同时存在，则 npm 会忽略黑名单的配置。</p>
</blockquote>
<p>配置好要发布的文件后，运行 <code>npm pack --dry-run</code> 命令可以验证哪些文件会被发布。</p>
<p>每次开源库有更新都会向 npm 发布新的包，npm 通过版本号来管理一个库的不同版本。</p>
<p>发布到 npm 上的包需要遵循语义化版本，其格式为 “主版本号.次版本号.修订号-先行版本号”，可以简写为 “x.y.z-prerelease”，每一位的含义如下：</p>
<ul>
<li><p>x 代表不兼容的改动</p>
</li>
<li><p>y 代表新增了功能，向下兼容（当 x 为 0 时，y 的变更也可以不向下兼容）</p>
</li>
<li><p>z 代表修复 Bug，向下兼容</p>
</li>
<li><p>prerelease 是可选的，可以是被 “.” 分割的任意字符</p>
</li>
</ul>
<p>prerelease 一般用来发布测试版本，在程序尚未稳定时，可以先发布测试版本，稳定后再发布正式版本</p>
<p>下面是一组测试版本号和正式版本号的示例：</p>
<pre><code class="language-sh"># 测试版本号
1.0.0-alpha.1
1.0.0-beta.1

# 正式版本号
1.0.0
1.0.1
</code></pre>
<p><strong>下面开始发布版本：</strong></p>
<p>在发布新版本前，首先需要修改版本号，同时要同步更新 CHANGELOG.md 文件，添加变更记录，然后直接运行 publish 命令即可。</p>
<p>正式包发布很简单，而测试包则需要借助 npm 提供的标签功能，如果不添加标签，则默认会发布到 latest 标签，发布到其他标签（如 beta）的包需要指定版本号才能安装，</p>
<pre><code class="language-sh">npm publish --tag=beta # 发布测试包
npm publish # 发布正式包
</code></pre>
<p>如果是位于 scope 下的包，如位于 jslib-book 这个组织下的包 @jslib-book/clone1，那么直接使用 npm 发布会遇到如下报错：</p>
<pre><code class="language-sh">$ npm publish
npm ERR! code E402
npm ERR! 402 Payment Required - PUT https://registry.npmjs.org/@jslib-book%2fclone1 - You must sign up for private packages
</code></pre>
<p>这是因为 npm 命令在发布 scope 下的包时，会默认将其发布为私有包，然而只有付费用户才可以发布私有包。此时只需要给 npm 命令添加参数 <code>--access public</code>，将包发布为公开包即可。</p>
<pre><code class="language-sh">npm publish --access public # 发布成功
</code></pre>
<p>如果不想每次发布包时都添加参数，则可以修改 package.json 文件，在该文件中添加 publishConfig 字段，publishConfig 字段配置如下，这样在发布包时就可以在 npm 命令中省略参数 <code>--access public</code> 了。</p>
<pre><code class="language-json">{
  &quot;publishConfig&quot;: {
    &quot;registry&quot;: &quot;https://registry.npmjs.org&quot;,
    &quot;access&quot;: &quot;public&quot;
  }
}
</code></pre>
<p>在发布成功后，还需要添加 Git tag，如果没有 Git tag，那么当想要找到历史上某个版本对应的源代码时，就需要翻找 Git 历史才能找到，既麻烦，又容易出错，</p>
<pre><code class="language-sh">git tag 1.0.0 # 添加指定版本的 tag
git push --tags # 将 tag 推送到远端
</code></pre>
<p>npm 提供了 version 命令也可以修改版本号，和手动修改版本号相比，npm 除了可以修改版本号，还可以自动添加 Git tag。</p>
<p>npm 提供了 4 个子命令，分别用来修改版本号的 4 个位置。</p>
<pre><code class="language-sh"># 初始版本号是 1.0.0
npm version prerelease --preid=beta # 修改版本号为 1.0.0-beta.0
npm version prerelease --preid=beta # 修改版本号为 1.0.0-beta.1
npm version patch # 修改版本号为 1.0.1
npm version minor # 修改版本号为 1.1.0
npm version major # 修改版本号为 2.0.0
</code></pre>
<h3>下载安装包</h3>
<p>在包发布成功之后，可以使用 npm 命令安装测试。需要注意的是，对于测试版本的包，需要显示指定版本号才可以安装成功。</p>
<pre><code class="language-sh">npm i @jslib-book/clone1 # 安装最新正式版本
npm i @jslib-book/clone1@1.0.0-beta.1 # 安装测试版本
</code></pre>
<h2>统计数据</h2>
<p>发布后可以关注库的使用情况，及时了解库的使用数据，以及库的受欢迎程度，</p>
<h3>Github 数据</h3>
<p><strong>1. GitHub 数据</strong></p>
<p><strong>2. npm 数据</strong></p>
<p><strong>3. 自定义数据</strong></p>
<p>npm 命令行为每个执行的命令都提供了 pre 和 post 钩子，分别代表命令执行之前和之后。</p>
<p>例如，在执行 <code>npm install</code> 命令时，npm 实际上会执行下面 3 条命令：</p>
<pre><code class="language-sh">npm run preinstall
npm install
npm run postinstall
</code></pre>
<p>通过 npm 提供的 postinstall 钩子，即可实现自定义统计数据。</p>
<p>首先修改 package.json 文件，注册 postinstall 钩子，</p>
<pre><code class="language-json">{
  &quot;scripts&quot;: {
    &quot;postinstall&quot;: &quot;node postinstall.js&quot;
  }
}
</code></pre>
<p>当使用者安装我们的库时，会自动使用 Node.js 执行 postinstall.js 文件中的内容，需要注意的是，如果使用者在安装我们的库时使用了参数 <code>--ignore-scripts</code>，则跳过执行 postinstall 钩子。</p>
<pre><code class="language-sh">npm install xxx # 执行 postinstall.js 文件
npm install --ignore-scripts xxx # 不执行 postinstall.js 文件
</code></pre>
<p>在项目根目录下添加 postinstall.js 文件，</p>
<pre><code class="language-js">const axios = require(&quot;axios&quot;).default;

axios.get(&quot;/tongji/install_count&quot;).then(function (response) {
  console.log(response);
});
</code></pre>
<p>对于一般公司内部的项目，可以通过上述方式来收集更详细的信息，如仓库地址等，而对于公开的项目，则应该谨慎使用上述方式来统计数据，使用 postinstall 钩子来统计数据在开源库中比较少见，postinstall 钩子常见的用法是安装后做一些初始化工作。</p>

        </article>
      </main>

      <!-- Table of Contents Sidebar -->
      <aside class="toc-sidebar">
        <div class="toc-header">
          <h3>Table of Contents</h3>
        </div>
        <div class="toc-content" id="tocContent">
          <!-- TOC will be generated dynamically -->
        </div>
      </aside>
    </div>

    <div class="body_bg"></div>
    <div class="zoom-overlay"></div>

    <button id="backToTop" class="back-to-top" aria-label="Back to top">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M12 19V5M5 12l7-7 7 7" />
      </svg>
    </button>

    <style>
      .zoom-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        z-index: 1000;
        cursor: zoom-out;
      }
      .zoomed-image {
        position: fixed;
        z-index: 1001;
        will-change: transform;
        cursor: zoom-out;
        max-width: 90vw;
        max-height: 90vh;
        object-fit: contain;
      }
      .back-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border-radius: 100%;
        background-color: #07a;
        border: none;
        color: #333;
        text-decoration: none;
        font-size: 14px;
        margin-bottom: 16px;
        cursor: pointer;
        transition: background-color 0.2s;
        position: fixed !important;
        top: 30px;
        right: 30px;
        z-index: 10;
        display: none;
      }
      .back-button svg {
        width: 50%;
        height: 50%;
      }
      .back-button:hover {
        opacity: 0.8;
      }
      .layout {
        position: relative;
        z-index: 1;
      }
      .back-to-top {
        position: fixed;
        bottom: 2rem;
        right: 340px;
        background: linear-gradient(
          135deg,
          var(--accent),
          rgba(59, 130, 246, 0.8)
        );
        color: white;
        border: none;
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
      }

      .back-to-top svg {
        width: 1.5rem;
        height: 1.5rem;
        stroke: currentColor;
        transition: transform 0.3s ease;
      }

      .back-to-top:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
        background: linear-gradient(135deg, var(--accent), #2563eb);
      }

      .back-to-top:hover svg {
        transform: translateY(-2px);
      }

      .dark .back-to-top {
        background: linear-gradient(135deg, #4b5563, #1f2937);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .dark .back-to-top:hover {
        background: linear-gradient(135deg, #4b5563, #111827);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
      }
      @media screen and (max-width: 768px) {
        .back-to-top {
          right: 15px;
          bottom: 15px;
          width: 36px;
          height: 36px;
        }
      }

      @media screen and (max-width: 480px) {
        .back-to-top {
          right: 12px;
          bottom: 12px;
          width: 32px;
          height: 32px;
        }
      }
    </style>
    <script defer src="../js/prism.min.js"></script>
    <script>
      // Sidebar Toggle
      const toggleBtn = document.getElementById("toggleSidebar");
      const sidebar = document.querySelector(".sidebar");
      const mainContent = document.querySelector(".main-content");

      function toggleSidebar() {
        sidebar.classList.toggle("hidden");
        // Store sidebar state in localStorage
        localStorage.setItem(
          "sidebarHidden",
          sidebar.classList.contains("hidden")
        );
      }

      toggleBtn.addEventListener("click", toggleSidebar);

      // Keyboard shortcut (Ctrl + B)
      window.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "b") {
          e.preventDefault(); // Prevent browser's default behavior
          toggleSidebar();
        }
      });

      // Restore sidebar state from localStorage
      document.addEventListener("DOMContentLoaded", () => {
        const sidebarHidden = localStorage.getItem("sidebarHidden") === "true";
        if (sidebarHidden) {
          sidebar.classList.add("hidden");
        }
      });

      // Generate Table of Contents
      function generateTOC() {
        const article = document.querySelector(".content-body");
        const headings = article.querySelectorAll("h1, h2, h3, h4");
        const tocContent = document.getElementById("tocContent");
        const toc = document.createElement("ul");

        headings.forEach((heading, index) => {
          const id = `heading-${index}`;
          heading.id = id;

          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = `#${id}`;
          a.textContent = heading.textContent;
          a.className = `toc-level-${heading.tagName.toLowerCase()}`;

          li.appendChild(a);
          toc.appendChild(li);
        });

        tocContent.appendChild(toc);
      }

      // Initialize TOC
      document.addEventListener("DOMContentLoaded", generateTOC);

      // Image zoom with FLIP animation
      const overlay = document.querySelector(".zoom-overlay");
      let activeImage = null;

      document.querySelectorAll("img").forEach((img) => {
        if (img.closest("a")) return; // Skip images that are inside links
        img.style.cursor = "zoom-in";
        img.addEventListener("click", handleImageClick);
      });

      function handleImageClick(event) {
        const img = event.target;

        if (activeImage) {
          // If an image is already zoomed, unzoom it
          unzoomImage();
          return;
        }

        // Get the initial position and size
        const rect = img.getBoundingClientRect();
        const first = {
          x: rect.left,
          y: rect.top,
          width: rect.width,
          height: rect.height,
        };

        // Create a clone of the image
        const clone = img.cloneNode();
        clone.classList.add("zoomed-image");
        document.body.appendChild(clone);

        // Position the clone exactly over the original
        clone.style.position = "fixed";
        clone.style.left = `${first.x}px`;
        clone.style.top = `${first.y}px`;
        clone.style.width = `${first.width}px`;
        clone.style.height = `${first.height}px`;
        clone.style.margin = "0";
        clone.style.transformOrigin = "top left";

        // Show the overlay
        overlay.style.display = "block";

        // Calculate the final position and scale
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const targetWidth = Math.min(img.naturalWidth, viewportWidth * 0.9);
        const targetHeight = Math.min(img.naturalHeight, viewportHeight * 0.9);
        const scaleX = targetWidth / first.width;
        const scaleY = targetHeight / first.height;
        const scale = Math.min(scaleX, scaleY);

        const last = {
          width: first.width * scale,
          height: first.height * scale,
        };
        last.x = (viewportWidth - last.width) / 2;
        last.y = (viewportHeight - last.height) / 2;

        // Calculate and apply the transform
        const dx = last.x - first.x;
        const dy = last.y - first.y;

        requestAnimationFrame(() => {
          clone.style.transform = `translate(${dx}px, ${dy}px) scale(${scale})`;
          clone.style.transition = "transform 0.3s ease-out";
        });

        activeImage = { original: img, clone: clone };

        // Add click handlers for closing
        clone.addEventListener("click", unzoomImage);
        overlay.addEventListener("click", unzoomImage);
      }

      function unzoomImage() {
        if (!activeImage) return;

        const { original, clone } = activeImage;
        const rect = original.getBoundingClientRect();

        // Animate back to the original position
        clone.style.transform = `translate(0, 0) scale(1)`;

        // Clean up after the animation
        clone.addEventListener(
          "transitionend",
          () => {
            clone.remove();
            overlay.style.display = "none";
          },
          { once: true }
        );

        activeImage = null;
      }

      // 监听 ctrl + b
      window.addEventListener("keydown", (e) => {
        const leftDom = document.querySelector(".sidebar");
        if (e.ctrlKey && e.key === "b") {
          leftDom.classList.toggle("hidden");
        }
      });

      // Modal
      // const modal = document.getElementById("myModal");
      // const modalContent = modal.querySelector(".modal-content");
      // const openModal = document.getElementById("openModal");
      // const close = modal.querySelector(".close");

      // openModal.addEventListener("click", () => {
      //     modal.style.display = "block";
      // });

      // close.addEventListener("click", () => {
      //     modal.style.display = "none";
      // });

      // window.addEventListener("click", (e) => {
      //     if (e.target === modal) {
      //         modal.style.display = "none";
      //     }
      // });

      // Back to top button
      const backToTop = document.getElementById("backToTop");
      window.addEventListener("scroll", () => {
        if (window.scrollY > 200) {
          backToTop.style.display = "block";
        } else {
          backToTop.style.display = "none";
        }
      });

      backToTop.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      // Theme toggle
      document.addEventListener("DOMContentLoaded", () => {
        const themeToggle = document.getElementById("themeToggle");
        const html = document.documentElement;
        const prismTheme = document.getElementById("prismTheme");

        // Function to update theme and stylesheet
        function updateTheme(theme) {
          html.className = theme;
          prismTheme.href = `../css/prism${theme === "dark" ? "2" : ""}.css`;
          localStorage.setItem("theme", theme);
        }

        // Check for saved theme preference
        const savedTheme = localStorage.getItem("theme") || "light";
        updateTheme(savedTheme);

        themeToggle.addEventListener("click", () => {
          const currentTheme = html.className;
          const newTheme = currentTheme === "light" ? "dark" : "light";
          updateTheme(newTheme);
        });
      });
    </script>
  </body>
</html>
