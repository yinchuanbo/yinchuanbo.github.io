<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>03 处理文件中的中文字符</title>
    <link rel="shortcut icon" href="../code.svg" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.css"
    />
    <link rel="stylesheet" href="../css/edit-code.css" />
  </head>
  <body>
    <div class="layout">
      <div class="layout__main">
        <div class="layout__main_left html__left">
          <ul><li data-id="39" data-path="chinese-translator.js"><svg t="1725441988000" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5301" width="200" height="200"><path d="M64 1024h960V576H64z" fill="#F4AF3D" fill-opacity=".7" p-id="5302"></path><path d="M448 64L192 320h256z" fill="#9AA7B0" fill-opacity=".8" p-id="5303"></path><path d="M512 64v320H192v128h640V64z" fill="#9AA7B0" fill-opacity=".8" p-id="5304"></path><path d="M153.28 869.632c14.72 16 28.352 26.368 57.088 26.368 33.664 0 45.632-26.368 45.632-44.928V640h64v229.632C320 916.48 276.928 960 220.8 960c-52.544 0-83.2-15.168-105.6-43.52l38.08-46.848zM446.272 736.128c0-23.616 19.904-32.128 55.808-32.128H576v-64H503.04C433.792 640 384 669.44 384 732.8c0 55.36 26.88 79.36 94.144 93.824 49.28 10.56 65.6 20.032 65.6 40.448 0 20.48-22.912 28.928-65.6 28.928H403.2v64h74.944C608 960 608 896 608 867.072c0-40.448-30.72-72.128-85.824-89.664-55.168-17.536-75.904-17.728-75.904-41.28z" fill="#231F20" fill-opacity=".7" p-id="5305"></path></svg>chinese-translator.js</li><li data-id="40" data-path="detect-chinese.js"><svg t="1725441988000" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5301" width="200" height="200"><path d="M64 1024h960V576H64z" fill="#F4AF3D" fill-opacity=".7" p-id="5302"></path><path d="M448 64L192 320h256z" fill="#9AA7B0" fill-opacity=".8" p-id="5303"></path><path d="M512 64v320H192v128h640V64z" fill="#9AA7B0" fill-opacity=".8" p-id="5304"></path><path d="M153.28 869.632c14.72 16 28.352 26.368 57.088 26.368 33.664 0 45.632-26.368 45.632-44.928V640h64v229.632C320 916.48 276.928 960 220.8 960c-52.544 0-83.2-15.168-105.6-43.52l38.08-46.848zM446.272 736.128c0-23.616 19.904-32.128 55.808-32.128H576v-64H503.04C433.792 640 384 669.44 384 732.8c0 55.36 26.88 79.36 94.144 93.824 49.28 10.56 65.6 20.032 65.6 40.448 0 20.48-22.912 28.928-65.6 28.928H403.2v64h74.944C608 960 608 896 608 867.072c0-40.448-30.72-72.128-85.824-89.664-55.168-17.536-75.904-17.728-75.904-41.28z" fill="#231F20" fill-opacity=".7" p-id="5305"></path></svg>detect-chinese.js</li></ul>
          <div class="left__border"></div>
        </div>
        <div class="layout__main_right"></div>
        
          <div class="layout__main_nav">
            <a href="/articles/html/03 处理文件中的中文字符 - download/download.zip"><svg t="1725527866228" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6724" width="25" height="25"><path d="M896 672c-17.066667 0-32 14.933333-32 32v128c0 6.4-4.266667 10.666667-10.666667 10.666667H170.666667c-6.4 0-10.666667-4.266667-10.666667-10.666667v-128c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v128c0 40.533333 34.133333 74.666667 74.666667 74.666667h682.666666c40.533333 0 74.666667-34.133333 74.666667-74.666667v-128c0-17.066667-14.933333-32-32-32z" fill="#fff" p-id="6725"></path><path d="M488.533333 727.466667c6.4 6.4 14.933333 8.533333 23.466667 8.533333s17.066667-2.133333 23.466667-8.533333l213.333333-213.333334c12.8-12.8 12.8-32 0-44.8-12.8-12.8-32-12.8-44.8 0l-157.866667 157.866667V170.666667c0-17.066667-14.933333-32-32-32s-34.133333 14.933333-34.133333 32v456.533333L322.133333 469.333333c-12.8-12.8-32-12.8-44.8 0-12.8 12.8-12.8 32 0 44.8l211.2 213.333334z" fill="#fff" p-id="6726"></path></svg></a>
          </div>
        
      </div>
    </div>
    <pre id="pre" style="display: none">{
  &#34;chinese-translator.js&#34;: &#34;const fs = require(\&#34;fs\&#34;);\r\nconst path = require(\&#34;path\&#34;);\r\nconst { translate } = require(\&#34;@vitalets/google-translate-api\&#34;);\r\n\r\n// 简单的内存缓存\r\nconst translationCache = new Map();\r\n\r\n// 延迟函数\r\nconst delay = (ms) =&gt; new Promise((resolve) =&gt; setTimeout(resolve, ms));\r\n\r\n// 获取目录下的JS和CSS文件（不包括子目录）\r\nfunction getFiles(dir) {\r\n  const files = fs.readdirSync(dir);\r\n  return files\r\n    .filter(\r\n      (file) =&gt;\r\n        file.endsWith(\&#34;.js\&#34;) || file.endsWith(\&#34;.css\&#34;) || file.endsWith(\&#34;.ejs\&#34;)\r\n    )\r\n    .map((file) =&gt; path.join(dir, file));\r\n}\r\n\r\n// 带重试的翻译函数\r\nasync function translateWithRetry(text, retries = 3, delayMs = 1000) {\r\n  if (translationCache.has(text)) {\r\n    return translationCache.get(text);\r\n  }\r\n  for (let i = 0; i &lt; retries; i++) {\r\n    try {\r\n      const result = await translate(text, { to: \&#34;en\&#34; });\r\n      translationCache.set(text, result.text);\r\n      return result.text;\r\n    } catch (error) {\r\n      console.error(`Translation error (attempt ${i + 1}): ${error.message}`);\r\n      if (i &lt; retries - 1) {\r\n        console.log(`Retrying in ${delayMs / 1000} seconds...`);\r\n        await delay(delayMs);\r\n        delayMs *= 2; // 指数退避\r\n      } else {\r\n        console.error(\&#34;Max retries reached. Skipping this translation.\&#34;);\r\n        return text; // 返回原文\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// 翻译中文字符为英文\r\nasync function translateChinese(content) {\r\n  const chineseRegex = /[\\u4e00-\\u9fa5]+/g;\r\n  let match;\r\n  let promises = [];\r\n  let matches = [];\r\n\r\n  while ((match = chineseRegex.exec(content)) !== null) {\r\n    const chineseText = match[0];\r\n    matches.push(match);\r\n    promises.push(translateWithRetry(chineseText));\r\n  }\r\n\r\n  const translations = await Promise.all(promises);\r\n  translations.forEach((translation, index) =&gt; {\r\n    const match = matches[index];\r\n    content = content.replace(match[0], translation);\r\n  });\r\n\r\n  return content;\r\n}\r\n\r\n// 处理单个文件\r\nasync function processFile(filePath) {\r\n  try {\r\n    let content = fs.readFileSync(filePath, \&#34;utf8\&#34;);\r\n    content = await translateChinese(content);\r\n    fs.writeFileSync(filePath, content, \&#34;utf8\&#34;);\r\n    console.log(`Processed: ${filePath}`);\r\n  } catch (error) {\r\n    console.error(`Error processing ${filePath}: ${error.message}`);\r\n  }\r\n}\r\n\r\n// 主函数\r\nasync function main(directory) {\r\n  let files = getFiles(directory);\r\n  // files = files.filter((file) =&gt; !file.includes(\&#34;.min.\&#34;));\r\n  for (const file of files) {\r\n    await processFile(file);\r\n    await delay(1000); // 在处理文件之间添加延迟\r\n  }\r\n  console.log(\&#34;All files processed.\&#34;);\r\n}\r\n\r\n// 运行处理多个语言目录\r\nconst langs = [\&#34;ar\&#34;, \&#34;de\&#34;, \&#34;en\&#34;, \&#34;es\&#34;, \&#34;fr\&#34;, \&#34;it\&#34;, \&#34;jp\&#34;, \&#34;kr\&#34;, \&#34;pt\&#34;, \&#34;tw\&#34;];\r\nfor (let i = 0; i &lt; langs.length; i++) {\r\n  const lan = langs[i];\r\n  const targetDirectory = `./${lan}/dist/js`;\r\n  main(targetDirectory);\r\n}\r\n&#34;,
  &#34;detect-chinese.js&#34;: &#34;const fs = require(\&#34;fs\&#34;);\r\nconst path = require(\&#34;path\&#34;);\r\n\r\nconst type = \&#34;ejs\&#34;; // js, css, or ejs\r\nconst chineseRegex = /[\\u4e00-\\u9fa5]/;\r\n\r\nfunction getFiles(dir) {\r\n  const files = fs.readdirSync(dir);\r\n  return files\r\n    .filter(\r\n      (file) =&gt;\r\n        file.endsWith(\&#34;.js\&#34;) || file.endsWith(\&#34;.css\&#34;) || file.endsWith(\&#34;.ejs\&#34;)\r\n    )\r\n    .map((file) =&gt; path.join(dir, file));\r\n}\r\n\r\nfunction checkFileForChineseCharacters(filePath) {\r\n  const content = fs.readFileSync(filePath, \&#34;utf8\&#34;);\r\n  const lines = content.split(\&#34;\\n\&#34;);\r\n  const chineseLines = [];\r\n\r\n  if (type === \&#34;ejs\&#34;) {\r\n    lines.forEach((line, index) =&gt; {\r\n      // Split the line into parts: before EJS tag, EJS tag content, after EJS tag\r\n      const parts = line.split(/&lt;%.*?%&gt;/);\r\n\r\n      parts.forEach((part, partIndex) =&gt; {\r\n        // Check for HTML comments in each part\r\n        if (part.includes(\&#34;&lt;!--\&#34;)) {\r\n          const commentContent = part.split(\&#34;&lt;!--\&#34;)[1].split(\&#34;--&gt;\&#34;)[0];\r\n          if (chineseRegex.test(commentContent)) {\r\n            chineseLines.push({ lineNumber: index + 1, content: line.trim() });\r\n          }\r\n        }\r\n\r\n        // Check for EJS comments\r\n        if (partIndex % 2 === 1 &amp;&amp; part.startsWith(\&#34;#\&#34;)) {\r\n          if (chineseRegex.test(part)) {\r\n            chineseLines.push({ lineNumber: index + 1, content: line.trim() });\r\n          }\r\n        }\r\n      });\r\n    });\r\n  } else {\r\n    lines.forEach((line, index) =&gt; {\r\n      if (chineseRegex.test(line)) {\r\n        chineseLines.push({ lineNumber: index + 1, content: line.trim() });\r\n      }\r\n    });\r\n  }\r\n\r\n  if (chineseLines.length &gt; 0) {\r\n    console.log(`文件 ${filePath} 包含 ${chineseLines.length} 行中文字符:`);\r\n    chineseLines.forEach(({ lineNumber, content }) =&gt; {\r\n      console.log(\r\n        `  第 ${lineNumber} 行: ${content.slice(0, 50)}${\r\n          content.length &gt; 50 ? \&#34;...\&#34; : \&#34;\&#34;\r\n        }`\r\n      );\r\n    });\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction main(directory) {\r\n  console.log(`检查目录: ${directory}`);\r\n  let files = getFiles(directory);\r\n  files = files.filter((file) =&gt; !file.includes(\&#34;.min.\&#34;));\r\n  console.log(`找到 ${files.length} 个 ${type.toUpperCase()} 文件\\n`);\r\n\r\n  let filesWithChineseCharacters = 0;\r\n  files.forEach((file) =&gt; {\r\n    if (checkFileForChineseCharacters(file)) {\r\n      filesWithChineseCharacters++;\r\n    }\r\n  });\r\n\r\n  console.log(`\\n检查完成。`);\r\n  console.log(\r\n    `总计 ${files.length} 个文件中有 ${filesWithChineseCharacters} 个文件包含中文字符。`\r\n  );\r\n}\r\n\r\nconst langs = [\&#34;ar\&#34;, \&#34;de\&#34;, \&#34;en\&#34;, \&#34;es\&#34;, \&#34;fr\&#34;, \&#34;it\&#34;, \&#34;jp\&#34;, \&#34;kr\&#34;, \&#34;pt\&#34;, \&#34;tw\&#34;];\r\nfor (let i = 0; i &lt; langs.length; i++) {\r\n  const lan = langs[i];\r\n  const targetDirectory = `./${lan}/${type}`;\r\n  main(targetDirectory);\r\n}\r\n&#34;
}</pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
    <script src="../js/edit.js"></script>
  </body>
</html>
