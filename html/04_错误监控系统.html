<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>04 错误监控系统</title>
    <link rel="shortcut icon" href="../code.svg" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.css"
    />
    <link rel="stylesheet" href="../css/edit-code.css" />
  </head>
  <body>
    <div class="layout">
      <div class="layout__main">
        <div class="layout__main_left html__left">
          <ul><li data-id="40" data-path="add-error-monitoring.js"><svg t="1725441988000" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5301" width="200" height="200"><path d="M64 1024h960V576H64z" fill="#F4AF3D" fill-opacity=".7" p-id="5302"></path><path d="M448 64L192 320h256z" fill="#9AA7B0" fill-opacity=".8" p-id="5303"></path><path d="M512 64v320H192v128h640V64z" fill="#9AA7B0" fill-opacity=".8" p-id="5304"></path><path d="M153.28 869.632c14.72 16 28.352 26.368 57.088 26.368 33.664 0 45.632-26.368 45.632-44.928V640h64v229.632C320 916.48 276.928 960 220.8 960c-52.544 0-83.2-15.168-105.6-43.52l38.08-46.848zM446.272 736.128c0-23.616 19.904-32.128 55.808-32.128H576v-64H503.04C433.792 640 384 669.44 384 732.8c0 55.36 26.88 79.36 94.144 93.824 49.28 10.56 65.6 20.032 65.6 40.448 0 20.48-22.912 28.928-65.6 28.928H403.2v64h74.944C608 960 608 896 608 867.072c0-40.448-30.72-72.128-85.824-89.664-55.168-17.536-75.904-17.728-75.904-41.28z" fill="#231F20" fill-opacity=".7" p-id="5305"></path></svg>add-error-monitoring.js</li><li data-id="41" data-path="clear-error-monitoring.js"><svg t="1725441988000" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5301" width="200" height="200"><path d="M64 1024h960V576H64z" fill="#F4AF3D" fill-opacity=".7" p-id="5302"></path><path d="M448 64L192 320h256z" fill="#9AA7B0" fill-opacity=".8" p-id="5303"></path><path d="M512 64v320H192v128h640V64z" fill="#9AA7B0" fill-opacity=".8" p-id="5304"></path><path d="M153.28 869.632c14.72 16 28.352 26.368 57.088 26.368 33.664 0 45.632-26.368 45.632-44.928V640h64v229.632C320 916.48 276.928 960 220.8 960c-52.544 0-83.2-15.168-105.6-43.52l38.08-46.848zM446.272 736.128c0-23.616 19.904-32.128 55.808-32.128H576v-64H503.04C433.792 640 384 669.44 384 732.8c0 55.36 26.88 79.36 94.144 93.824 49.28 10.56 65.6 20.032 65.6 40.448 0 20.48-22.912 28.928-65.6 28.928H403.2v64h74.944C608 960 608 896 608 867.072c0-40.448-30.72-72.128-85.824-89.664-55.168-17.536-75.904-17.728-75.904-41.28z" fill="#231F20" fill-opacity=".7" p-id="5305"></path></svg>clear-error-monitoring.js</li><li data-id="42" data-path="error-monitoring-template.js"><svg t="1725441988000" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5301" width="200" height="200"><path d="M64 1024h960V576H64z" fill="#F4AF3D" fill-opacity=".7" p-id="5302"></path><path d="M448 64L192 320h256z" fill="#9AA7B0" fill-opacity=".8" p-id="5303"></path><path d="M512 64v320H192v128h640V64z" fill="#9AA7B0" fill-opacity=".8" p-id="5304"></path><path d="M153.28 869.632c14.72 16 28.352 26.368 57.088 26.368 33.664 0 45.632-26.368 45.632-44.928V640h64v229.632C320 916.48 276.928 960 220.8 960c-52.544 0-83.2-15.168-105.6-43.52l38.08-46.848zM446.272 736.128c0-23.616 19.904-32.128 55.808-32.128H576v-64H503.04C433.792 640 384 669.44 384 732.8c0 55.36 26.88 79.36 94.144 93.824 49.28 10.56 65.6 20.032 65.6 40.448 0 20.48-22.912 28.928-65.6 28.928H403.2v64h74.944C608 960 608 896 608 867.072c0-40.448-30.72-72.128-85.824-89.664-55.168-17.536-75.904-17.728-75.904-41.28z" fill="#231F20" fill-opacity=".7" p-id="5305"></path></svg>error-monitoring-template.js</li><li data-id="43" data-path="start.js"><svg t="1725441988000" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5301" width="200" height="200"><path d="M64 1024h960V576H64z" fill="#F4AF3D" fill-opacity=".7" p-id="5302"></path><path d="M448 64L192 320h256z" fill="#9AA7B0" fill-opacity=".8" p-id="5303"></path><path d="M512 64v320H192v128h640V64z" fill="#9AA7B0" fill-opacity=".8" p-id="5304"></path><path d="M153.28 869.632c14.72 16 28.352 26.368 57.088 26.368 33.664 0 45.632-26.368 45.632-44.928V640h64v229.632C320 916.48 276.928 960 220.8 960c-52.544 0-83.2-15.168-105.6-43.52l38.08-46.848zM446.272 736.128c0-23.616 19.904-32.128 55.808-32.128H576v-64H503.04C433.792 640 384 669.44 384 732.8c0 55.36 26.88 79.36 94.144 93.824 49.28 10.56 65.6 20.032 65.6 40.448 0 20.48-22.912 28.928-65.6 28.928H403.2v64h74.944C608 960 608 896 608 867.072c0-40.448-30.72-72.128-85.824-89.664-55.168-17.536-75.904-17.728-75.904-41.28z" fill="#231F20" fill-opacity=".7" p-id="5305"></path></svg>start.js</li></ul>
          <div class="left__border"></div>
        </div>
        <div class="layout__main_right"></div>
        
          <div class="layout__main_nav">
            <a href="/articles/html/04 错误监控系统 - download/download.zip"><svg t="1725527866228" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6724" width="25" height="25"><path d="M896 672c-17.066667 0-32 14.933333-32 32v128c0 6.4-4.266667 10.666667-10.666667 10.666667H170.666667c-6.4 0-10.666667-4.266667-10.666667-10.666667v-128c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v128c0 40.533333 34.133333 74.666667 74.666667 74.666667h682.666666c40.533333 0 74.666667-34.133333 74.666667-74.666667v-128c0-17.066667-14.933333-32-32-32z" fill="#fff" p-id="6725"></path><path d="M488.533333 727.466667c6.4 6.4 14.933333 8.533333 23.466667 8.533333s17.066667-2.133333 23.466667-8.533333l213.333333-213.333334c12.8-12.8 12.8-32 0-44.8-12.8-12.8-32-12.8-44.8 0l-157.866667 157.866667V170.666667c0-17.066667-14.933333-32-32-32s-34.133333 14.933333-34.133333 32v456.533333L322.133333 469.333333c-12.8-12.8-32-12.8-44.8 0-12.8 12.8-12.8 32 0 44.8l211.2 213.333334z" fill="#fff" p-id="6726"></path></svg></a>
          </div>
        
      </div>
    </div>
    <pre id="pre" style="display: none">{
  &#34;add-error-monitoring.js&#34;: &#34;const fs = require(\&#34;fs\&#34;);\r\nconst { minify } = require(\&#34;terser\&#34;);\r\nconst path = require(\&#34;path\&#34;);\r\n\r\nconst sourceFilePath = path.join(__dirname, \&#34;error-monitoring-template.js\&#34;);\r\n\r\nconst langs = [\&#34;ar\&#34;, \&#34;de\&#34;, \&#34;en\&#34;, \&#34;es\&#34;, \&#34;fr\&#34;, \&#34;it\&#34;, \&#34;jp\&#34;, \&#34;kr\&#34;, \&#34;pt\&#34;, \&#34;tw\&#34;];\r\n\r\nlangs.forEach((lan) =&gt; {\r\n  const destinationFilePath = path.join(\r\n    __dirname,\r\n    lan,\r\n    \&#34;dist/js/error-monitoring.min.js\&#34;\r\n  );\r\n  const patilesPath = `./${lan}/patiles`;\r\n  const scriptTag =\r\n    &#39;&lt;script type=\&#34;text/javascript\&#34; src=\&#34;/dist/js/error-monitoring.min.js\&#34;&gt;&lt;/script&gt;\\n&#39;;\r\n  function processDirectorySync(dirPath) {\r\n    try {\r\n      const files = fs.readdirSync(dirPath);\r\n      files.forEach((file) =&gt; {\r\n        const filePath = path.join(dirPath, file);\r\n        const stats = fs.statSync(filePath);\r\n        if (stats.isDirectory()) {\r\n          processDirectorySync(filePath);\r\n        } else if (path.extname(file) === \&#34;.ejs\&#34; &amp;&amp; file.endsWith(\&#34;head.ejs\&#34;)) {\r\n          processFileSync(filePath);\r\n        }\r\n      });\r\n    } catch (err) {\r\n      console.error(\&#34;Unable to scan directory:\&#34;, err);\r\n    }\r\n  }\r\n\r\n  function processFileSync(filePath) {\r\n    try {\r\n      const data = fs.readFileSync(filePath, \&#34;utf8\&#34;);\r\n      if (data.includes(scriptTag)) {\r\n        console.log(`Script already exists in: ${filePath}`);\r\n        return;\r\n      }\r\n      const updatedData = scriptTag + data;\r\n      fs.writeFileSync(filePath, updatedData, \&#34;utf8\&#34;);\r\n      console.log(`Script added to: ${filePath}`);\r\n    } catch (err) {\r\n      console.error(\&#34;Error reading or writing file:\&#34;, err);\r\n    }\r\n  }\r\n\r\n  try {\r\n    const codeContent = fs.readFileSync(sourceFilePath, \&#34;utf8\&#34;);\r\n    minify(codeContent).then((minified) =&gt; {\r\n      try {\r\n        fs.writeFileSync(destinationFilePath, minified.code);\r\n        processDirectorySync(patilesPath);\r\n      } catch (err) {\r\n        console.error(\&#34;Error writing to the destination file:\&#34;, err);\r\n      }\r\n    });\r\n  } catch (err) {\r\n    console.error(\&#34;Error reading the source file:\&#34;, err);\r\n  }\r\n});\r\n&#34;,
  &#34;clear-error-monitoring.js&#34;: &#34;const fs = require(\&#34;fs\&#34;);\r\nconst { glob } = require(\&#34;glob\&#34;);\r\n\r\n// 要删除的 script 标签\r\nconst scriptToRemove = /(\\r?\\n)?&lt;script type=\&#34;text\\/javascript\&#34; src=\&#34;\\/dist\\/js\\/error-monitoring\\.min\\.js\&#34;&gt;&lt;\\/script&gt;(\\r?\\n)?/g;\r\n\r\n// 匹配的文件路径\r\nconst patterns = [\&#34;**/*.ejs\&#34;, \&#34;**/*.html\&#34;];\r\n\r\n\r\npatterns.forEach(async (pattern) =&gt; {\r\n  const files = await glob(pattern, { ignore: \&#34;node_modules/**\&#34; });\r\n  files.forEach((file) =&gt; {\r\n    fs.readFile(file, \&#34;utf8\&#34;, (err, data) =&gt; {\r\n      if (err) {\r\n        console.error(`Error reading file ${file}: ${err}`);\r\n        return;\r\n      }\r\n\r\n      // 删除指定的 script 标签\r\n      const result = data.replace(new RegExp(scriptToRemove, \&#34;g\&#34;), \&#34;\&#34;);\r\n\r\n      // 如果文件内容有所改变，则写回文件\r\n      if (result !== data) {\r\n        fs.writeFile(file, result, \&#34;utf8\&#34;, (err) =&gt; {\r\n          if (err) {\r\n            console.error(`Error writing file ${file}: ${err}`);\r\n          } else {\r\n            console.log(`Removed script from ${file}`);\r\n          }\r\n        });\r\n      } else {\r\n        console.log(`No changes made to ${file}`);\r\n      }\r\n    });\r\n  });\r\n});\r\n&#34;,
  &#34;error-monitoring-template.js&#34;: &#34;let APIURL_ERROR = \&#34;api/notification/exception\&#34;,\r\n  DOMAIN_ERROR = \&#34;miocreate.com\&#34;,\r\n  ISPRO_ERROR = location.host === `www.${DOMAIN_ERROR}` || false,\r\n  APIDOMAIN_ERROR = ISPRO_ERROR\r\n    ? `https://tool-api.${DOMAIN_ERROR}/`\r\n    : `https://tool-api-test.${DOMAIN_ERROR}/`,\r\n  SEND_ERRORAPI = `${APIDOMAIN_ERROR}${APIURL_ERROR}`;\r\nconst ComprehensiveErrorMonitor = {\r\n  lastErrorInfos: [],\r\n  lastIsComplete: true,\r\n  lastRequestTime: 0,\r\n  requestThrottle: 10000,\r\n  requestTimeout: 20000,\r\n  init: function () {\r\n    this.setupGlobalErrorHandler();\r\n    this.setupPromiseErrorHandler();\r\n    this.setupRequestErrorHandler();\r\n    // this.setupConsoleErrorHandler();\r\n    this.setupResourceErrorHandler();\r\n    this.setupCustomElementsErrorHandler();\r\n    this.setupWebWorkerErrorHandler();\r\n    this.setupEventListenerErrors();\r\n    this.setupFrameErrors();\r\n  },\r\n  convertToTimeZone: function (isoString, timeZone = \&#34;Asia/Shanghai\&#34;) {\r\n    const date = new Date(isoString);\r\n    return date.toLocaleString(\&#34;zh-CN\&#34;, { timeZone });\r\n  },\r\n  handleError: function (error, errorType) {\r\n    const errorInfo = {\r\n      type: errorType,\r\n      message: error.message || error,\r\n      stack: error.stack || \&#34;\&#34;,\r\n      url: window.location.href,\r\n      userAgent: navigator.userAgent,\r\n      timestamp: this.convertToTimeZone(new Date().toISOString()),\r\n      env: ISPRO_ERROR ? \&#34;pro\&#34; : \&#34;dev\&#34;,\r\n    };\r\n    if (errorInfo?.message?.includes?.(APIURL_ERROR)) {\r\n      console.warn(`Error in ${APIURL_ERROR} ignored to prevent loop.`);\r\n      return;\r\n    }\r\n    this.sendErrorToServer(errorInfo);\r\n  },\r\n  setupGlobalErrorHandler: function () {\r\n    window.onerror = (message, source, lineno, colno, error) =&gt; {\r\n      this.handleError(error || message, \&#34;Global JavaScript Error\&#34;);\r\n      return true;\r\n    };\r\n  },\r\n  setupPromiseErrorHandler: function () {\r\n    window.addEventListener(\&#34;unhandledrejection\&#34;, (event) =&gt; {\r\n      this.handleError(event.reason, \&#34;Unhandled Promise Rejection\&#34;);\r\n    });\r\n  },\r\n  noHandleUrlByReq: function (url = \&#34;\&#34;) {\r\n    return (\r\n      url.includes(\&#34;google\&#34;) ||\r\n      url.includes(\&#34;facebook\&#34;) ||\r\n      url.includes(\&#34;twitter\&#34;) ||\r\n      url.includes(\&#34;linkedin\&#34;) ||\r\n      url.includes(\&#34;youtube\&#34;)\r\n    );\r\n  },\r\n  setupRequestErrorHandler: function () {\r\n    const _this = this;\r\n    const originalXHRSend = XMLHttpRequest.prototype.send;\r\n    XMLHttpRequest.prototype.send = function () {\r\n      const xhr = this;\r\n      const url = xhr._url || this.responseURL || \&#34;\&#34;;\r\n      const isOtherUrl = _this.noHandleUrlByReq(url);\r\n      this.addEventListener(\&#34;error\&#34;, (event) =&gt; {\r\n        if (!isOtherUrl) {\r\n          ComprehensiveErrorMonitor.handleError(\r\n            `AJAX Error: ${url} failed`,\r\n            \&#34;AJAX Error\&#34;\r\n          );\r\n        }\r\n      });\r\n      this.addEventListener(\&#34;load\&#34;, () =&gt; {\r\n        if (!isOtherUrl &amp;&amp; xhr.status &gt;= 400) {\r\n          ComprehensiveErrorMonitor.handleError(\r\n            `HTTP ${xhr.status}: ${xhr.statusText} at ${url}`,\r\n            \&#34;AJAX Error\&#34;\r\n          );\r\n        }\r\n      });\r\n      originalXHRSend.apply(this, arguments);\r\n    };\r\n    const originalOpen = XMLHttpRequest.prototype.open;\r\n    XMLHttpRequest.prototype.open = function (method, url) {\r\n      this._url = url;\r\n      originalOpen.apply(this, arguments);\r\n    };\r\n    if (window.fetch) {\r\n      const originalFetch = window.fetch;\r\n      window.fetch = function (input, options) {\r\n        let url = input;\r\n        if (typeof input === \&#34;object\&#34; &amp;&amp; input.url) {\r\n          url = input.url;\r\n        }\r\n        const isOtherUrl = _this.noHandleUrlByReq(url);\r\n        return originalFetch\r\n          .apply(this, arguments)\r\n          .then((response) =&gt; {\r\n            if (!isOtherUrl &amp;&amp; !response.ok) {\r\n              ComprehensiveErrorMonitor.handleError(\r\n                `HTTP ${response.status}: ${response.statusText} at ${response.url}`,\r\n                \&#34;Fetch Error\&#34;\r\n              );\r\n            }\r\n            return response;\r\n          })\r\n          .catch((error) =&gt; {\r\n            if (!isOtherUrl) {\r\n              ComprehensiveErrorMonitor.handleError(\r\n                `Fetch Error: ${url}`,\r\n                \&#34;Fetch Error\&#34;\r\n              );\r\n            }\r\n            throw error;\r\n          });\r\n      };\r\n    }\r\n  },\r\n  setupConsoleErrorHandler: function () {\r\n    const originalConsoleError = console.error;\r\n    console.error = (...args) =&gt; {\r\n      this.handleError(args.join(\&#34; \&#34;), \&#34;Console Error\&#34;);\r\n      originalConsoleError.apply(console, args);\r\n    };\r\n  },\r\n  setupResourceErrorHandler: function () {\r\n    const _this = this;\r\n    window.addEventListener(\r\n      \&#34;error\&#34;,\r\n      (event) =&gt; {\r\n        if (\r\n          event.target &amp;&amp;\r\n          (event.target.tagName === \&#34;LINK\&#34; ||\r\n            event.target.tagName === \&#34;SCRIPT\&#34; ||\r\n            event.target.tagName === \&#34;IMG\&#34;)\r\n        ) {\r\n          if (\r\n            event.target.tagName === \&#34;IMG\&#34; &amp;&amp;\r\n            !event.target.getAttribute(\&#34;src\&#34;)\r\n          )\r\n            return;\r\n          const src = event.target.src || event.target.href;\r\n          const isOtherUrl = _this.noHandleUrlByReq(src);\r\n          if (!isOtherUrl) {\r\n            this.handleError(\r\n              `Failed to load resource: ${event.target?.outerHTML || src}`,\r\n              \&#34;Resource Load Error\&#34;\r\n            );\r\n          }\r\n        }\r\n      },\r\n      true\r\n    );\r\n  },\r\n  setupCustomElementsErrorHandler: function () {\r\n    if (window.customElements) {\r\n      const originalDefine = window.customElements.define;\r\n      window.customElements.define = function (name, constructor, options) {\r\n        try {\r\n          return originalDefine.call(\r\n            window.customElements,\r\n            name,\r\n            constructor,\r\n            options\r\n          );\r\n        } catch (error) {\r\n          ComprehensiveErrorMonitor.handleError(error, \&#34;Custom Element Error\&#34;);\r\n          throw error;\r\n        }\r\n      };\r\n    }\r\n  },\r\n  setupWebWorkerErrorHandler: function () {\r\n    if (window.Worker) {\r\n      const originalWorker = window.Worker;\r\n      window.Worker = function (scriptURL, options) {\r\n        const worker = new originalWorker(scriptURL, options);\r\n        worker.addEventListener(\&#34;error\&#34;, (event) =&gt; {\r\n          const errorMessage = `Error in worker: ${event.message} at ${event.filename}:${event.lineno}`;\r\n          ComprehensiveErrorMonitor.handleError(\r\n            errorMessage,\r\n            \&#34;Web Worker Error\&#34;\r\n          );\r\n        });\r\n\r\n        return worker;\r\n      };\r\n    }\r\n  },\r\n  setupEventListenerErrors: function () {\r\n    const originalAddEventListener = EventTarget.prototype.addEventListener;\r\n    const originalRemoveEventListener =\r\n      EventTarget.prototype.removeEventListener;\r\n    const wrappedListeners = new WeakMap();\r\n\r\n    EventTarget.prototype.addEventListener = function (\r\n      type,\r\n      listener,\r\n      options\r\n    ) {\r\n      if (typeof listener !== \&#34;function\&#34;) {\r\n        throw new TypeError(\&#34;Listener must be a function\&#34;);\r\n      }\r\n\r\n      const wrappedListener = function (event) {\r\n        try {\r\n          listener.call(this, event);\r\n        } catch (error) {\r\n          ComprehensiveErrorMonitor.handleError(error, \&#34;Event Listener Error\&#34;);\r\n          throw error;\r\n        }\r\n      };\r\n\r\n      wrappedListeners.set(listener, wrappedListener);\r\n      return originalAddEventListener.call(\r\n        this,\r\n        type,\r\n        wrappedListener,\r\n        options\r\n      );\r\n    };\r\n\r\n    EventTarget.prototype.removeEventListener = function (\r\n      type,\r\n      listener,\r\n      options\r\n    ) {\r\n      const wrappedListener = wrappedListeners.get(listener);\r\n      if (wrappedListener) {\r\n        return originalRemoveEventListener.call(\r\n          this,\r\n          type,\r\n          wrappedListener,\r\n          options\r\n        );\r\n      } else {\r\n        return originalRemoveEventListener.call(this, type, listener, options);\r\n      }\r\n    };\r\n  },\r\n  setupFrameErrors: function () {\r\n    window.addEventListener(\&#34;error\&#34;, (event) =&gt; {\r\n      const error = event.error || event.message;\r\n      this.handleError(error, \&#34;Frame Error\&#34;);\r\n      event.preventDefault();\r\n    });\r\n  },\r\n  sendErrorToServer: function (errorInfo) {\r\n    const currentTime = Date.now();\r\n    const findObj = this.lastErrorInfos.find(\r\n      (item) =&gt;\r\n        item.message === errorInfo.message &amp;&amp;\r\n        item.stack === errorInfo.stack &amp;&amp;\r\n        item.url === errorInfo.url\r\n    );\r\n    if (\r\n      findObj ||\r\n      !this.lastIsComplete ||\r\n      currentTime - this.lastRequestTime &lt; this.requestThrottle\r\n    ) {\r\n      return;\r\n    }\r\n    this.lastIsComplete = false;\r\n    this.lastRequestTime = currentTime;\r\n\r\n    if (navigator?.sendBeacon) {\r\n      navigator.sendBeacon(SEND_ERRORAPI, JSON.stringify(errorInfo));\r\n      this.lastIsComplete = true;\r\n      this.lastErrorInfos.push(errorInfo);\r\n    } else {\r\n      const timeoutPromise = new Promise((_, reject) =&gt;\r\n        setTimeout(\r\n          () =&gt; reject(new Error(\&#34;Request timed out\&#34;)),\r\n          this.requestTimeout\r\n        )\r\n      );\r\n      const fetchPromise = fetch(SEND_ERRORAPI, {\r\n        method: \&#34;POST\&#34;,\r\n        headers: {\r\n          \&#34;Content-Type\&#34;: \&#34;application/json\&#34;,\r\n        },\r\n        body: JSON.stringify(errorInfo),\r\n      });\r\n      Promise.race([fetchPromise, timeoutPromise])\r\n        .then(() =&gt; {\r\n          this.lastIsComplete = true;\r\n          this.lastErrorInfos.push(errorInfo);\r\n        })\r\n        .catch((error) =&gt; {\r\n          this.lastIsComplete = true;\r\n          if (error.message === \&#34;Request timed out\&#34;) {\r\n            console.warn(\&#34;Request to server timed out.\&#34;);\r\n          } else {\r\n            console.warn(\&#34;Failed to send error to server:\&#34;, error);\r\n          }\r\n        });\r\n    }\r\n  },\r\n};\r\nComprehensiveErrorMonitor.init();\r\n&#34;,
  &#34;start.js&#34;: &#34;const chokidar = require(\&#34;chokidar\&#34;);\r\nconst liveServer = require(\&#34;live-server\&#34;);\r\nconst sass = require(\&#34;node-sass\&#34;);\r\nconst { minify } = require(\&#34;terser\&#34;);\r\nvar ejs = require(\&#34;ejs\&#34;);\r\nconst path = require(\&#34;path\&#34;);\r\nconst fs = require(\&#34;fs\&#34;).promises;\r\nconst fs2 = require(\&#34;fs\&#34;);\r\n\r\nconst langs = [\&#34;ar\&#34;, \&#34;de\&#34;, \&#34;en\&#34;, \&#34;es\&#34;, \&#34;fr\&#34;, \&#34;it\&#34;, \&#34;jp\&#34;, \&#34;kr\&#34;, \&#34;pt\&#34;, \&#34;tw\&#34;],\r\n  noWatchList = [\r\n    \&#34;bottom-message\&#34;,\r\n    \&#34;credits\&#34;,\r\n    \&#34;pay\&#34;,\r\n    \&#34;share-dialog\&#34;,\r\n    \&#34;popup\&#34;,\r\n    \&#34;confirm-dialog\&#34;,\r\n    \&#34;commonSignin\&#34;,\r\n  ];\r\n\r\nconst compressAndObfuscate = async (filePath, curLan = \&#34;\&#34;) =&gt; {\r\n  const pathArr = filePath.split(\&#34;\\\\\&#34;);\r\n  const filename = pathArr[pathArr.length - 1];\r\n  const name = filename.split(\&#34;.\&#34;);\r\n  try {\r\n    const LanPath = `./${curLan}/dist/lan/index.js`;\r\n    delete require.cache[require.resolve(LanPath)];\r\n    let jsonData = require(LanPath);\r\n    const templatePath = path.join(__dirname, filePath);\r\n    ejs.renderFile(\r\n      templatePath,\r\n      {\r\n        ...jsonData,\r\n        faceSSwap: JSON.stringify(jsonData.faceSwap),\r\n        allData: JSON.stringify(jsonData),\r\n        voice_Generator: JSON.stringify(jsonData.voiceGenerator),\r\n      },\r\n      (err, result) =&gt; {\r\n        if (err) {\r\n          console.log(err);\r\n          return;\r\n        }\r\n        const htmlPath = path.join(__dirname, `./${curLan}/${name[0]}.html`);\r\n        fs2.writeFileSync(htmlPath, result);\r\n      }\r\n    );\r\n  } catch (error) {\r\n    console.error(`${filePath} 编译时出错：`, error);\r\n  }\r\n};\r\n\r\nasync function asyncEs6Json(curLan = \&#34;\&#34;) {\r\n  delete require.cache[require.resolve(`./${curLan}/dist/lan/index.js`)];\r\n  let jsonData = require(`./${curLan}/dist/lan/index.js`);\r\n  await fs.writeFile(\r\n    path.join(`./`, `./${curLan}/dist/lan/es6.js`),\r\n    `var jsonData = ${JSON.stringify(\r\n      jsonData,\r\n      null,\r\n      2\r\n    )}; export default jsonData`\r\n  );\r\n  await fs.writeFile(\r\n    path.join(`./`, `./${curLan}/dist/lan/normal.js`),\r\n    `var jsonData = ${JSON.stringify(jsonData, null, 2)}`\r\n  );\r\n}\r\n\r\nfunction getAllFilePaths(dirPath) {\r\n  const files = fs2.readdirSync(dirPath);\r\n  const filePaths = [];\r\n  for (const file of files) {\r\n    const filePath = `${dirPath}/${file}`;\r\n    if (fs2.statSync(filePath).isDirectory()) {\r\n      filePaths.push(...getAllFilePaths(filePath));\r\n    } else {\r\n      filePaths.push(filePath);\r\n    }\r\n  }\r\n  return filePaths;\r\n}\r\n\r\nconst compileSCSS = (filePath, curLan = \&#34;\&#34;) =&gt; {\r\n  return new Promise((resolve, reject) =&gt; {\r\n    const outputFilePath = path.join(\r\n      `./${curLan}/dist/css`,\r\n      path.basename(filePath).replace(\&#34;.scss\&#34;, \&#34;.css\&#34;)\r\n    );\r\n    sass.render(\r\n      {\r\n        file: filePath,\r\n        outputStyle: \&#34;compressed\&#34;,\r\n        outFile: outputFilePath,\r\n      },\r\n      (error, result) =&gt; {\r\n        if (!error) {\r\n          fs.writeFile(outputFilePath, result.css)\r\n            .then(() =&gt; {\r\n              console.log(`SCSS 文件 ${filePath} 编译成功！`);\r\n              resolve();\r\n            })\r\n            .catch((error) =&gt; {\r\n              console.error(\r\n                `写入编译后的 SCSS 文件 ${outputFilePath} 时出错：`,\r\n                error\r\n              );\r\n              reject(error);\r\n            });\r\n        } else {\r\n          console.error(`编译 SCSS 文件 ${filePath} 时出错：`, error);\r\n          reject(error);\r\n        }\r\n      }\r\n    );\r\n  });\r\n};\r\n\r\nconst compressJS = async (filePath, curLan = \&#34;\&#34;) =&gt; {\r\n  try {\r\n    const fileContent = await fs.readFile(filePath, \&#34;utf-8\&#34;);\r\n    const minified = await minify(fileContent);\r\n    let originalFileName = null;\r\n    originalFileName = path.basename(filePath, path.extname(filePath));\r\n    if (originalFileName === \&#34;blogDetail\&#34;) {\r\n      originalFileName = `blogDetail.js`;\r\n    } else {\r\n      originalFileName = `${originalFileName}.min.js`;\r\n    }\r\n    await fs.writeFile(\r\n      path.join(`./${curLan}/dist/js`, originalFileName),\r\n      minified.code\r\n    );\r\n    console.log(`文件 ${filePath} 压缩和混淆成功！`);\r\n  } catch (error) {\r\n    console.error(`压缩和混淆文件 ${filePath} 时出错：`, error);\r\n  }\r\n};\r\n\r\nfor (let i = 0; i &lt; langs.length; i++) {\r\n  let curPort = 6170;\r\n  curPort += i;\r\n  const lan = langs[i];\r\n  const ejsSourceDir = `./${lan}/ejs`;\r\n  const patilesDir = `./${lan}/patiles`;\r\n  const jsSourceDir = `./${lan}/dev/js`;\r\n  const scssSourceDir = `./${lan}/dev/scss`;\r\n  const lanJsPath = `./${lan}/dist/lan/index.js`;\r\n  const watcher = chokidar.watch(\r\n    [ejsSourceDir, jsSourceDir, scssSourceDir, patilesDir],\r\n    {\r\n      ignoreInitial: true,\r\n    }\r\n  );\r\n  watcher.on(\&#34;change\&#34;, async (filePath) =&gt; {\r\n    if (filePath.endsWith(\&#34;.ejs\&#34;)) {\r\n      if (filePath.includes(\&#34;patiles\&#34;) || filePath.includes(\&#34;components\&#34;)) {\r\n        const filePaths = getAllFilePaths(ejsSourceDir);\r\n        for (let i = 0; i &lt; filePaths.length; i++) {\r\n          let p = filePaths[i];\r\n          if (p.endsWith(\&#34;.ejs\&#34;) &amp;&amp; !p.includes(\&#34;components\&#34;)) {\r\n            p = p.replace(/\\//g, \&#34;\\\\\&#34;);\r\n            await compressAndObfuscate(p, lan);\r\n          }\r\n        }\r\n      } else {\r\n        await compressAndObfuscate(filePath, lan);\r\n      }\r\n    } else if (\r\n      filePath.endsWith(\&#34;.js\&#34;) &amp;&amp;\r\n      filePath.includes(\&#34;/dev/js/\&#34;) &amp;&amp;\r\n      !filePath.includes(\&#34;.min\&#34;)\r\n    ) {\r\n      try {\r\n        const folders = filePath.split(\&#34;\\\\\&#34;);\r\n        const parentFolder = folders[folders.length - 2];\r\n        if (!noWatchList.includes(parentFolder)) {\r\n          await compressJS(filePath, lan);\r\n        }\r\n      } catch (e) {\r\n        console.log(e);\r\n      }\r\n    } else if (filePath.endsWith(\&#34;.scss\&#34;) &amp;&amp; filePath.includes(\&#34;/dev/scss/\&#34;)) {\r\n      try {\r\n        await compileSCSS(filePath, lan);\r\n      } catch (e) {\r\n        console.log(e);\r\n      }\r\n    }\r\n  });\r\n  fs2.watchFile(lanJsPath, async (curr, prev) =&gt; {\r\n    if (curr.mtime !== prev.mtime) {\r\n      const filePaths = getAllFilePaths(ejsSourceDir);\r\n      for (let i = 0; i &lt; filePaths.length; i++) {\r\n        let p = filePaths[i];\r\n        if (p.endsWith(\&#34;.ejs\&#34;) &amp;&amp; !p.includes(\&#34;components\&#34;)) {\r\n          p = p.replace(/\\//g, \&#34;\\\\\&#34;);\r\n          await asyncEs6Json(lan);\r\n          await compressAndObfuscate(p, lan);\r\n        }\r\n      }\r\n      console.log(\&#34;执行完成\&#34;);\r\n    }\r\n  });\r\n  var params = {\r\n    port: curPort,\r\n    host: \&#34;0.0.0.0\&#34;,\r\n    root: `./${lan}`,\r\n    open: false,\r\n  };\r\n  liveServer.start(params);\r\n}\r\n&#34;
}</pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
    <script src="../js/edit.js"></script>
  </body>
</html>
