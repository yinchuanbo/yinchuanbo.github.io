---
title: "å‰ç«¯å®ç°ç”»ä¸­ç”»è¶…ç®€å•ï¼Œè®©ç½‘é¡µé£å‡ºæµè§ˆå™¨"
tag: "éŸ³è§†é¢‘"
time: 2025-01-19 17:39:38
---

## Document Picture-in-Picture ä»‹ç»

ä»Šå¤©ï¼Œæˆ‘æ¥ä»‹ç»ä¸€ä¸ªéå¸¸é…·çš„å‰ç«¯åŠŸèƒ½ï¼š**æ–‡æ¡£ç”»ä¸­ç”»** (Document Picture-in-Picture, æœ¬æ–‡ç®€ç§° PiP)ã€‚ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œç½‘é¡µä¸Šçš„ä»»ä½•å†…å®¹èƒ½æ‚¬æµ®åœ¨æ¡Œé¢ä¸Šï¼ŸğŸ˜

### è§†é¢‘æµåª’ä½“çš„ç”»ä¸­ç”»åŠŸèƒ½

ä½ å¯èƒ½å·²ç»åœ¨è§†é¢‘å¹³å°ï¼ˆå¦‚`è…¾è®¯è§†é¢‘`ã€`å“”å“©å“”å“©`ç­‰ç½‘é¡µï¼‰è§è¿‡è¿™ç§æ•ˆæœï¼šè§†é¢‘æ’­æ”¾æ—¶ï¼Œå¯ä»¥ç‚¹å‡»ç”»ä¸­ç”»åã€‚æ— è®ºä½ åˆ‡æ¢é¡µé¢ï¼Œå®ƒéƒ½å§‹ç»ˆæ˜¾ç¤ºåœ¨å±å¹•çš„æœ€ä¸Šå±‚ï¼Œéå¸¸é€‚åˆ`ä¸Šç­å·å·çœ‹ç”µè§†`

<img src="../imgs/138/01.gif" />

åœ¨ä»Šå¤©çš„æ•™ç¨‹ä¸­ï¼Œä¸ä»…ä»…æ˜¯è§†é¢‘ï¼Œæˆ‘å°†æ•™ä½ å¦‚ä½•`å°†ä»»ä½• HTML å†…å®¹æ”¾å…¥ç”»ä¸­ç”»`æ¨¡å¼ï¼Œæ— è®ºæ˜¯åŠ¨æ€å†…å®¹ã€æ–‡æœ¬ã€å›¾ç‰‡ï¼Œè¿˜æ˜¯çº¯ç‚«é…·çš„ divï¼Œç»Ÿç»Ÿéƒ½èƒ½â€œé£â€èµ·æ¥ã€‚âœ¨

ä¸€ä¸ªå¦‚æ­¤æœ‰è¶£çš„åŠŸèƒ½ï¼Œåœ¨ç½‘ä¸Šå´å¾ˆå°‘æœ‰è¯¦ç»†çš„æ•™ç¨‹æ¥ä»‹ç»è¿™ä¸ªåŠŸèƒ½çš„ä½¿ç”¨ã€‚äºæ˜¯æˆ‘å†³å®šå†™ä¸€ç¯‡è¯¦ç»†çš„æ•™ç¨‹æ¥æ•™å¤§å®¶å¦‚ä½•å®ç°ç”»ä¸­ç”» (å»ºè®®æ”¶è—)ğŸ˜

> ä½“éªŒç½‘å€ï¼š[Treasure-Navigation](https://xionglongbing.github.io/Treasure-Navigation/)

<img src="../imgs/138/02.gif" />

[github åœ°å€](https://github.com/xionglongbing/Treasure-Navigation)

## Document Picture-in-Picture è¯¦ç»†æ•™ç¨‹

### HTML åŸºæœ¬ä»£ç ç»“æ„

é¦–å…ˆï¼Œæˆ‘ä»¬éšä¾¿å†™ä¸€ä¸ªç®€å•çš„ `HTML é¡µé¢`ï¼Œåç»­çš„ JS å’Œæ ·å¼éƒ½ä¼šåŸºäºå®ƒå®ç°ã€‚

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document Picture-in-Picture API ç¤ºä¾‹</title>
    <style>
      #pipContent {
        width: 600px;
        height: 300px;
        background: pink;
        font-size: 20px;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <div id="pipContent">è¿™æ˜¯ä¸€ä¸ªå°†è¦æ”¾å…¥ç”»ä¸­ç”»çš„ div å…ƒç´ ï¼</div>
      <button id="clickBtn">åˆ‡æ¢ç”»ä¸­ç”»</button>
    </div>
    <script>
      // åœ¨è¿™é‡Œå†™ä½ çš„ JavaScript ä»£ç 
    </script>
  </body>
</html>
```

### 1. è¯·æ±‚ PiP çª—å£

`PiP` çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ `window.documentPictureInPicture.requestWindow`ã€‚å®ƒæ˜¯ä¸€ä¸ª `å¼‚æ­¥æ–¹æ³•`ï¼Œè¿”å›ä¸€ä¸ªæ–°åˆ›å»ºçš„ `window` å¯¹è±¡ã€‚

`PIP çª—å£`å¯ä»¥å°†å…¶çœ‹ä½œä¸€ä¸ªæ–°çš„ç½‘é¡µï¼Œä½†å®ƒå§‹ç»ˆæ‚¬æµ®åœ¨å±å¹•ä¸Šæ–¹ã€‚

```js
document
  .getElementById("clickBtn")
  .addEventListener("click", async function () {
    // è·å–å°†è¦æ”¾å…¥ PiP çª—å£çš„ DOM å…ƒç´ 
    const pipContent = document.getElementById("pipContent");
    // è¯·æ±‚åˆ›å»ºä¸€ä¸ª PiP çª—å£
    const pipWindow = await window.documentPictureInPicture.requestWindow({
      width: 200, // è®¾ç½®çª—å£çš„å®½åº¦
      height: 300, // è®¾ç½®çª—å£çš„é«˜åº¦
    });

    // å°†åŸå§‹å…ƒç´ æ·»åŠ åˆ° PiP çª—å£ä¸­
    pipWindow.document.body.appendChild(pipContent);
  });
```

æ¼”ç¤ºï¼š

<img src="../imgs/138/20.webp" />

**ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªç”»ä¸­ç”»çª—å£ï¼** è¿™æ®µä»£ç å±•ç¤ºäº†å¦‚ä½•å°†ç½‘é¡µä¸­çš„å…ƒç´ æ”¾å…¥ä¸€ä¸ªæ–°çš„ç”»ä¸­ç”»çª—å£ï¼Œå¹¶è®©å®ƒæ‚¬æµ®åœ¨æœ€ä¸Šé¢ã€‚éå¸¸ç®€å•å§

**å…³é—­ PIP çª—å£**

å¯ä»¥ç›´æ¥ç‚¹å³ä¸Šè§’å…³é—­ PIP çª—å£ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨ä»£ç ä¸­å®ç°å…³é—­ï¼Œç›´æ¥è°ƒç”¨`windowä¸Šçš„api`å°±å¯ä»¥äº†

```js
window.documentPictureInPicture.window.close();
```

### 2. æ£€æŸ¥æ˜¯å¦æ”¯æŒ PiP åŠŸèƒ½

ä¸€åˆ‡ä¸èƒ½**å…¼å®¹æµè§ˆå™¨**çš„åŠŸèƒ½ä»‹ç»éƒ½æ˜¯è€æµæ°“ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦`æ”¯æŒPIIPåŠŸèƒ½`ã€‚ å®é™…å°±æ˜¯æ£€æŸ¥ documentPictureInPicture å±æ€§æ˜¯å¦å­˜åœ¨äº window ä¸Š

```js
if ("documentPictureInPicture" in window) {
  console.log("ğŸš€ æµè§ˆå™¨æ”¯æŒ PiP åŠŸèƒ½ï¼");
} else {
  console.warn("âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ PiP åŠŸèƒ½ï¼Œæ›´æ–°æµè§ˆå™¨æˆ–è€…æ¢å°ç”µè„‘å§ï¼");
}
```

å¦‚æœæ˜¯åªéœ€è¦å°†è§†é¢‘å®ç°ç”»ä¸­ç”»åŠŸèƒ½ï¼Œ`è§†é¢‘ç”»ä¸­ç”» (Picture-in-Picture)` çš„å…¼å®¹æ€§ä¼šå¥½ä¸€ç‚¹ï¼Œä½†æ˜¯å®ƒåªèƒ½å°†å…ƒç´ æ”¾å…¥ç”»ä¸­ç”»çª—å£ã€‚å®ƒä¸æœ¬æ–‡ä»‹ç»çš„ `æ–‡æ¡£ç”»ä¸­ç”»(Document Picture-in-Picture)` ä½¿ç”¨æ–¹æ³•ä¹Ÿæ˜¯ååˆ†ç›¸ä¼¼çš„ã€‚

### 3. è®¾ç½® PiP æ ·å¼

æˆ‘ä»¬ä¼šå‘ç°åˆšåˆšåˆ›å»ºçš„ç”»ä¸­ç”»`æ²¡æœ‰æ ·å¼`ï¼Œä¸€ç‚¹éƒ½ä¸ç¾è§‚ã€‚é‚£æ˜¯å› ä¸ºæˆ‘ä»¬åªæ”¾å…¥äº† dom å…ƒç´ ï¼Œæ²¡æœ‰æ·»åŠ  css æ ·å¼ã€‚

**3.1. å…¨å±€æ ·å¼åŒæ­¥**

å‡è®¾ç½‘é¡µä¸­çš„æ‰€æœ‰æ ·å¼å¦‚ä¸‹ï¼š

```html
<head>
  <style>
    #pipContent {
      width: 600px;
      height: 300px;
      background: pink;
      font-size: 20px;
    }
  </style>
  <link rel="stylesheet" type="text/css" href="https://abc.css" />
</head>
```

ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠä¹‹å‰çš„ç½‘é¡µçš„`cssæ ·å¼å…¨éƒ¨èµ‹å€¼ç»™ç”»ä¸­ç”»`ã€‚

```js
// 1. document.styleSheetsè·å–æ‰€æœ‰çš„cssæ ·å¼ä¿¡æ¯
[...document.styleSheets].forEach((styleSheet) => {
  try {
    // è½¬æˆå­—ç¬¦ä¸²æ–¹ä¾¿èµ‹å€¼
    const cssRules = [...styleSheet.cssRules]
      .map((rule) => rule.cssText)
      .join("");
    // åˆ›å»ºstyleæ ‡ç­¾
    const style = document.createElement("style");
    // è®¾ç½®ä¸ºä¹‹å‰é¡µé¢ä¸­çš„cssä¿¡æ¯
    style.textContent = cssRules;
    console.log("style", style);
    // æŠŠstyleæ ‡ç­¾æ”¾åˆ°ç”»ä¸­ç”»çš„<head><head/>æ ‡ç­¾ä¸­
    pipWindow.document.head.appendChild(style);
  } catch (e) {
    // é€šè¿‡ link å¼•å…¥æ ·å¼ï¼Œå¦‚æœæœ‰è·¨åŸŸï¼Œè®¿é—®styleSheet.cssRulesæ—¶ä¼šæŠ¥é”™ã€‚æ²¡æœ‰è·¨åŸŸåˆ™ä¸ä¼šæŠ¥é”™
    const link = document.createElement("link");
    /**
     * rel = stylesheet å¯¼å…¥æ ·å¼è¡¨
     * type: å¯¹åº”çš„æ ¼å¼
     * media: åª’ä½“æŸ¥è¯¢ï¼ˆå¦‚ screen and (max-width: 600px)ï¼‰
     *  href: å¤–éƒ¨æ ·å¼è¡¨çš„ URL
     */
    link.rel = "stylesheet";
    link.type = styleSheet.type;
    link.media = styleSheet.media;
    link.href = styleSheet.href ?? "";
    console.log("error: link", link);
    pipWindow.document.head.appendChild(link);
  }
});
```

æ¼”ç¤ºï¼š

<img src="../imgs/138/21.webp" />

**3.2. ä½¿ç”¨ link å¼•å…¥å¤–éƒ¨ CSS æ–‡ä»¶**

å‘å…¶ä»–æ™®é€š`html`æ–‡ä»¶ä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡`link`æ ‡ç­¾å¼•å…¥ç‰¹å®š`css`æ–‡ä»¶:

åˆ›å»º `pip.css` æ–‡ä»¶:

```css
#pipContent {
  width: 600px;
  height: 300px;
  background: skyblue;
}
```

`js` å¼•ç”¨ï¼š

```js
// å…¶ä»–ä¸å˜
const link = document.createElement("link");
link.rel = "stylesheet";
link.href = "./pip.css"; // å¼•å…¥å¤–éƒ¨ CSS æ–‡ä»¶
pipWindow.document.head.appendChild(link);
pipWindow.document.body.appendChild(pipContent);
```

æ¼”ç¤ºï¼š

<img src="../imgs/138/22.webp" />

**3.3. åª’ä½“æŸ¥è¯¢çš„æ”¯æŒ**

å¯ä»¥è®¾ç½®åª’ä½“æŸ¥è¯¢ `@media (display-mode: picture-in-picture)`ã€‚åœ¨æ™®é€šé¡µé¢ä¸­ä¼šè‡ªåŠ¨å¿½ç•¥æ ·å¼ï¼Œåœ¨ç”»ä¸­ç”»æ¨¡å¼ä¼šè‡ªåŠ¨æ¸²æŸ“æ ·å¼

```html
<style>
  #pipContent {
    width: 600px;
    height: 300px;
    background: pink;
    font-size: 20px;
  }
  /* æ™®é€šç½‘é¡µä¸­ä¼šå¿½ç•¥ */
  @media (display-mode: picture-in-picture) {
    #pipContent {
      background: lightgreen;
    }
  }
</style>
```

åœ¨æ™®é€šé¡µé¢ä¸­æ˜¾ç¤ºä¸º`ç²‰è‰²`ï¼Œåœ¨ç”»ä¸­ç”»è‡ªåŠ¨å˜ä¸º`æµ…ç»¿è‰²`

æ¼”ç¤ºï¼š

<img src="../imgs/138/23.webp" />

### 4. ç›‘å¬è¿›å…¥å’Œé€€å‡º PiP æ¨¡å¼çš„äº‹ä»¶

æˆ‘ä»¬è¿˜å¯ä»¥ä¸º `PiP çª—å£` æ·»åŠ `äº‹ä»¶ç›‘å¬`ï¼Œç›‘æ§ç”»ä¸­ç”»æ¨¡å¼çš„ **è¿›å…¥** å’Œ **é€€å‡º**ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨ç”¨æˆ·æ“ä½œæ—¶ï¼Œåšå‡ºç›¸åº”çš„åé¦ˆï¼Œæ¯”å¦‚æ˜¾ç¤ºæç¤ºæˆ–æ‰§è¡Œå…¶ä»–æ“ä½œã€‚

```js
// è¿›å…¥ PIP äº‹ä»¶
documentPictureInPicture.addEventListener("enter", (event) => {
  console.log("å·²è¿›å…¥ PIP çª—å£");
});

const pipWindow = await window.documentPictureInPicture.requestWindow({
  width: 200,
  height: 300,
});
// é€€å‡º PIP äº‹ä»¶
pipWindow.addEventListener("pagehide", (event) => {
  console.log("å·²é€€å‡º PIP çª—å£");
});
```

æ¼”ç¤º

<img src="../imgs/138/24.webp" />

### 5. ç›‘å¬ PiP ç„¦ç‚¹å’Œå¤±ç„¦äº‹ä»¶

```js
const pipWindow = await window.documentPictureInPicture.requestWindow({
  width: 200,
  height: 300,
});

pipWindow.addEventListener("focus", () => {
  console.log("PiP çª—å£è¿›å…¥äº†ç„¦ç‚¹çŠ¶æ€");
});

pipWindow.addEventListener("blur", () => {
  console.log("PiP çª—å£å¤±å»äº†ç„¦ç‚¹");
});
```

æ¼”ç¤º

<img src="../imgs/138/26.webp" />

### 6. å…‹éš†èŠ‚ç‚¹ç”»ä¸­ç”»

æˆ‘ä»¬ä¼šå‘ç°æˆ‘ä»¬æŠŠåŸå§‹å…ƒç´ ä¼ å…¥åˆ° PIP çª—å£åï¼ŒåŸæ¥çª—å£ä¸­çš„å…ƒç´ å°±ä¸è§äº†ã€‚  
æˆ‘ä»¬å¯ä»¥æŠŠåŸå§‹å…ƒç´ å…‹éš†åå†ä¼ å…¥ç»™ PIP çª—å£ï¼Œè¿™æ ·åŸå§‹çª—å£ä¸­çš„å…ƒç´ å°±ä¸ä¼šæ¶ˆå¤±äº†

```js
const pipContent = document.getElementById("pipContent");
const pipWindow = await window.documentPictureInPicture.requestWindow({
  width: 200,
  height: 300,
});
// æ ¸å¿ƒä»£ç ï¼špipContent.cloneNode(true)
pipWindow.document.body.appendChild(pipContent.cloneNode(true));
```

æ¼”ç¤º

<img src="../imgs/138/25.webp" />

PIP å®Œæ•´ç¤ºä¾‹ä»£ç 

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document Picture-in-Picture API ç¤ºä¾‹</title>
    <style>
      #pipContent {
        width: 600px;
        height: 300px;
        background: pink;
        font-size: 20px;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="pipContent">è¿™æ˜¯ä¸€ä¸ªå°†è¦æ”¾å…¥ç”»ä¸­ç”»çš„ div å…ƒç´ ï¼</div>
      <button id="clickBtn">åˆ‡æ¢ç”»ä¸­ç”»</button>
    </div>

    <script>
      // æ£€æŸ¥æ˜¯å¦æ”¯æŒ PiP åŠŸèƒ½
      if ("documentPictureInPicture" in window) {
        console.log("ğŸš€ æµè§ˆå™¨æ”¯æŒ PiP åŠŸèƒ½ï¼");
      } else {
        console.warn(
          "âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ PiP åŠŸèƒ½ï¼Œæ›´æ–°æµè§ˆå™¨æˆ–è€…æ¢å°ç”µè„‘å§ï¼"
        );
      }

      // è¯·æ±‚ PiP çª—å£
      document
        .getElementById("clickBtn")
        .addEventListener("click", async function () {
          const pipContent = document.getElementById("pipContent");

          // è¯·æ±‚åˆ›å»ºä¸€ä¸ª PiP çª—å£
          const pipWindow = await window.documentPictureInPicture.requestWindow(
            {
              width: 200, // è®¾ç½®çª—å£çš„å®½åº¦
              height: 300, // è®¾ç½®çª—å£çš„é«˜åº¦
            }
          );

          // å°†åŸå§‹å…ƒç´ å…‹éš†å¹¶æ·»åŠ åˆ° PiP çª—å£ä¸­
          pipWindow.document.body.appendChild(pipContent.cloneNode(true));

          // è®¾ç½® PiP æ ·å¼åŒæ­¥
          [...document.styleSheets].forEach((styleSheet) => {
            try {
              const cssRules = [...styleSheet.cssRules]
                .map((rule) => rule.cssText)
                .join("");
              const style = document.createElement("style");
              style.textContent = cssRules;
              pipWindow.document.head.appendChild(style);
            } catch (e) {
              const link = document.createElement("link");
              link.rel = "stylesheet";
              link.type = styleSheet.type;
              link.media = styleSheet.media;
              link.href = styleSheet.href ?? "";
              pipWindow.document.head.appendChild(link);
            }
          });

          // ç›‘å¬è¿›å…¥å’Œé€€å‡º PiP æ¨¡å¼çš„äº‹ä»¶
          pipWindow.addEventListener("pagehide", (event) => {
            console.log("å·²é€€å‡º PIP çª—å£");
          });

          pipWindow.addEventListener("focus", () => {
            console.log("PiP çª—å£è¿›å…¥äº†ç„¦ç‚¹çŠ¶æ€");
          });

          pipWindow.addEventListener("blur", () => {
            console.log("PiP çª—å£å¤±å»äº†ç„¦ç‚¹");
          });
        });

      // å…³é—­ PiP çª—å£
      // pipWindow.close();  // å¯ä»¥æ‰‹åŠ¨è°ƒç”¨å…³é—­çª—å£
    </script>
  </body>
</html>
```
